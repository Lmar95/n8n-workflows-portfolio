{
  "name": "Cr√©ation Automatique des Propositions de Vente",
  "nodes": [
    {
      "parameters": {
        "content": "## üìÑ Cr√©ation Automatique des Propositions de Vente\n\n**Objectif :** Depuis le CRM, r√©cup√©rer les infos prospect et g√©n√©rer une proposition commerciale personnalis√©e en PDF (executive summary, enjeux, solution, m√©thodologie, livrables, ROI, √©tudes de cas, tarifs).\n\n**D√©clenchement :** Webhook POST `{\"dealId\": \"123456\"}` ou Bouton HubSpot\n\n**Configuration :**\n- `$vars.HUBSPOT_API_KEY`\n- `$vars.OPENAI_API_KEY`\n- `$vars.GOOGLE_DOCS_TEMPLATE_ID` (template de proposition)\n- `$vars.GOOGLE_DRIVE_FOLDER_ID`\n- `$vars.SALES_EMAIL`",
        "height": 280,
        "width": 480
      },
      "id": "sticky-doc",
      "name": "üìã Documentation",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [0, 0]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "generate-proposal",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "webhook",
      "name": "üåê Webhook - G√©n√©rer Proposition",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [560, 340]
    },
    {
      "parameters": {
        "resource": "deal",
        "operation": "get",
        "dealId": "={{ $json.body.dealId || $json.dealId }}"
      },
      "id": "get-deal",
      "name": "üîµ R√©cup√©rer Deal HubSpot",
      "type": "n8n-nodes-base.hubspot",
      "typeVersion": 2,
      "position": [800, 260]
    },
    {
      "parameters": {
        "resource": "contact",
        "operation": "getAll",
        "returnAll": false,
        "limit": 5,
        "additionalFields": {
          "filterGroups": [
            {
              "filters": [
                {
                  "propertyName": "associatedcompanyid",
                  "operator": "EQ",
                  "value": "={{ $('üîµ R√©cup√©rer Deal HubSpot').item.json.properties.associatedcompanyid }}"
                }
              ]
            }
          ]
        }
      },
      "id": "get-contacts",
      "name": "üë§ R√©cup√©rer Contacts Associ√©s",
      "type": "n8n-nodes-base.hubspot",
      "typeVersion": 2,
      "position": [800, 420]
    },
    {
      "parameters": {
        "jsCode": "// Compile all deal and contact information\nconst deal = $('üîµ R√©cup√©rer Deal HubSpot').item.json;\nconst contacts = $('üë§ R√©cup√©rer Contacts Associ√©s').all().map(i => i.json);\n\nconst mainContact = contacts[0] || {};\nconst props = deal.properties || {};\n\nconst dealInfo = {\n  dealName: props.dealname || 'Proposition Commerciale',\n  dealAmount: props.amount || '0',\n  dealStage: props.dealstage || '',\n  closeDate: props.closedate || '',\n  dealDescription: props.description || '',\n  pipeline: props.pipeline || '',\n  \n  // Contact info\n  contactFirstName: mainContact.properties?.firstname || 'Pr√©nom',\n  contactLastName: mainContact.properties?.lastname || 'Nom',\n  contactEmail: mainContact.properties?.email || '',\n  contactTitle: mainContact.properties?.jobtitle || '',\n  contactPhone: mainContact.properties?.phone || '',\n  \n  // Company info\n  companyName: mainContact.properties?.company || props.company || 'L\\'entreprise',\n  companyIndustry: mainContact.properties?.industry || '',\n  companySize: mainContact.properties?.numemployees || '',\n  \n  // Custom fields from notes/deal description\n  problemStatement: props.description || '',\n  budget: props.amount || '√Ä d√©finir',\n  timeline: props.closedate ? new Date(props.closedate).toLocaleDateString('fr-FR') : '√Ä d√©finir',\n  \n  generatedAt: new Date().toISOString(),\n  proposalNumber: `PROP-${new Date().getFullYear()}-${Date.now().toString().slice(-4)}`\n};\n\nreturn [{ json: dealInfo }];"
      },
      "id": "compile-info",
      "name": "‚öôÔ∏è Compiler Informations Deal",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1040, 340]
    },
    {
      "parameters": {
        "model": "gpt-4o",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "Tu es un expert commercial et consultant senior avec 15+ ans d'exp√©rience. Tu r√©diges des propositions commerciales qui convertissent. Style: professionnel, orient√© ROI, persuasif mais factuel. Tu √©cris en fran√ßais."
            },
            {
              "role": "user",
              "content": "=G√©n√®re une proposition commerciale compl√®te pour:\n\n**Prospect:**\n- Entreprise: {{ $json.companyName }}\n- Contact: {{ $json.contactFirstName }} {{ $json.contactLastName }}, {{ $json.contactTitle }}\n- Secteur: {{ $json.companyIndustry }}\n- Taille: {{ $json.companySize }} employ√©s\n\n**Deal:**\n- Objet: {{ $json.dealName }}\n- Budget estim√©: {{ $json.budget }}\n- Timeline: {{ $json.timeline }}\n- Contexte/Besoin: {{ $json.problemStatement }}\n\n**Num√©ro de proposition:** {{ $json.proposalNumber }}\n\nCr√©e une proposition JSON avec:\n{\n  \"executiveSummary\": \"R√©sum√© ex√©cutif 2-3 paragraphes percutants\",\n  \"situationAnalysis\": \"Analyse des enjeux actuels du prospect (3-4 paragraphes)\",\n  \"ourSolution\": \"Solution recommand√©e d√©taill√©e (4-5 paragraphes)\",\n  \"methodology\": \"M√©thodologie et approche √©tape par √©tape\",\n  \"deliverables\": [\"livrable1\", \"livrable2\", \"livrable3\"],\n  \"timeline\": [{\"phase\": \"Phase 1\", \"duration\": \"2 semaines\", \"activities\": [\"...\"]}],\n  \"investissement\": {\"description\": \"...\", \"value\": \"{{ $json.budget }}\", \"paymentTerms\": \"30 jours\"},\n  \"roiEstimate\": \"ROI estim√© et b√©n√©fices chiffr√©s\",\n  \"caseStudy\": \"√âtude de cas similaire pertinente\",\n  \"nextSteps\": [\"√©tape1\", \"√©tape2\", \"√©tape3\"],\n  \"validityDate\": \"Valable 30 jours\"\n}"
            }
          ]
        },
        "options": {
          "maxTokens": 3000,
          "response_format": { "type": "json_object" }
        }
      },
      "id": "generate-proposal",
      "name": "ü§ñ G√©n√©rer Proposition (GPT-4)",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.4,
      "position": [1280, 340]
    },
    {
      "parameters": {
        "jsCode": "// Parse and structure the proposal\nconst aiResponse = $input.first().json;\nconst content = aiResponse.message?.content || aiResponse.choices?.[0]?.message?.content || '{}';\nconst dealInfo = $('‚öôÔ∏è Compiler Informations Deal').item.json;\n\nlet proposalContent;\ntry {\n  proposalContent = JSON.parse(content);\n} catch(e) {\n  proposalContent = { executiveSummary: content };\n}\n\n// Build full HTML document for PDF generation\nconst htmlContent = `\n<!DOCTYPE html>\n<html lang=\"fr\">\n<head>\n<meta charset=\"UTF-8\">\n<style>\n  body { font-family: 'Arial', sans-serif; margin: 40px; color: #333; line-height: 1.6; }\n  .header { background: linear-gradient(135deg, #1a1a2e, #16213e); color: white; padding: 40px; border-radius: 10px; margin-bottom: 30px; }\n  .header h1 { margin: 0; font-size: 28px; }\n  .header p { margin: 5px 0; opacity: 0.8; }\n  .badge { background: #e74c3c; padding: 5px 15px; border-radius: 20px; font-size: 12px; display: inline-block; margin-top: 10px; }\n  h2 { color: #1a1a2e; border-left: 4px solid #e74c3c; padding-left: 15px; margin-top: 40px; }\n  .highlight-box { background: #f8f9fa; border-left: 4px solid #3498db; padding: 20px; margin: 20px 0; border-radius: 5px; }\n  .deliverable-list li { margin: 8px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; }\n  .timeline-item { display: flex; margin: 15px 0; }\n  .timeline-phase { background: #1a1a2e; color: white; padding: 10px 20px; border-radius: 5px; min-width: 120px; text-align: center; }\n  .investment-box { background: linear-gradient(135deg, #1a1a2e, #16213e); color: white; padding: 30px; border-radius: 10px; text-align: center; margin: 20px 0; }\n  .investment-box h3 { font-size: 24px; margin: 0; }\n  .next-steps li { margin: 10px 0; padding: 15px; background: #e8f5e9; border-radius: 5px; border-left: 4px solid #27ae60; }\n  .footer { text-align: center; margin-top: 50px; color: #666; font-size: 12px; border-top: 1px solid #eee; padding-top: 20px; }\n</style>\n</head>\n<body>\n<div class=\"header\">\n  <h1>Proposition Commerciale</h1>\n  <p>Pr√©par√©e pour: <strong>${dealInfo.companyName}</strong></p>\n  <p>Attention: ${dealInfo.contactFirstName} ${dealInfo.contactLastName}, ${dealInfo.contactTitle}</p>\n  <p>R√©f√©rence: ${dealInfo.proposalNumber}</p>\n  <div class=\"badge\">CONFIDENTIEL</div>\n</div>\n\n<h2>1. R√©sum√© Ex√©cutif</h2>\n<p>${proposalContent.executiveSummary || ''}</p>\n\n<h2>2. Analyse de votre Situation</h2>\n<div class=\"highlight-box\">${proposalContent.situationAnalysis || ''}</div>\n\n<h2>3. Notre Solution</h2>\n<p>${proposalContent.ourSolution || ''}</p>\n\n<h2>4. M√©thodologie</h2>\n<p>${proposalContent.methodology || ''}</p>\n\n<h2>5. Livrables</h2>\n<ul class=\"deliverable-list\">\n  ${(proposalContent.deliverables || []).map(d => `<li>‚úÖ ${d}</li>`).join('')}\n</ul>\n\n<h2>6. Planning</h2>\n${(proposalContent.timeline || []).map(t => `\n<div class=\"timeline-item\">\n  <div class=\"timeline-phase\">${t.phase}<br/><small>${t.duration}</small></div>\n  <ul style=\"margin-left:20px\">${(t.activities || []).map(a => `<li>${a}</li>`).join('')}</ul>\n</div>\n`).join('')}\n\n<h2>7. Investissement</h2>\n<div class=\"investment-box\">\n  <h3>${dealInfo.budget}</h3>\n  <p>${proposalContent.investissement?.description || ''}</p>\n  <p>Conditions: ${proposalContent.investissement?.paymentTerms || '30 jours fin de mois'}</p>\n</div>\n\n<h2>8. ROI Estim√©</h2>\n<div class=\"highlight-box\">${proposalContent.roiEstimate || ''}</div>\n\n<h2>9. Cas Client Similaire</h2>\n<p>${proposalContent.caseStudy || ''}</p>\n\n<h2>10. Prochaines √âtapes</h2>\n<ul class=\"next-steps\">\n  ${(proposalContent.nextSteps || []).map((s, i) => `<li><strong>√âtape ${i+1}:</strong> ${s}</li>`).join('')}\n</ul>\n\n<div class=\"footer\">\n  <p>Cette proposition est ${proposalContent.validityDate || 'valable 30 jours'}</p>\n  <p>G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} | ${dealInfo.proposalNumber}</p>\n</div>\n</body>\n</html>`;\n\nreturn [{\n  json: {\n    ...dealInfo,\n    proposalContent,\n    htmlContent,\n    proposalTitle: `Proposition ${dealInfo.proposalNumber} - ${dealInfo.companyName}`\n  }\n}];"
      },
      "id": "build-html",
      "name": "üìÑ Construire Document HTML",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1520, 340]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.pdfmonkey.io/api/v1/documents",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "=Bearer {{ $vars.PDFMONKEY_API_KEY }}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"document\": {\n    \"document_template_id\": \"{{ $vars.PDFMONKEY_TEMPLATE_ID }}\",\n    \"status\": \"pending\",\n    \"payload\": {\n      \"html\": {{ JSON.stringify($json.htmlContent) }},\n      \"proposalNumber\": \"{{ $json.proposalNumber }}\",\n      \"company\": \"{{ $json.companyName }}\"\n    },\n    \"meta\": \"proposal-{{ $json.proposalNumber }}\"\n  }\n}"
      },
      "id": "generate-pdf",
      "name": "üìë G√©n√©rer PDF (PDFMonkey)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1760, 220]
    },
    {
      "parameters": {
        "fromEmail": "={{ $vars.SALES_EMAIL }}",
        "toEmail": "={{ $json.contactEmail }}",
        "subject": "=Votre Proposition Commerciale - {{ $json.companyName }} | {{ $json.proposalNumber }}",
        "emailType": "html",
        "html": "=<html><body style='font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;'><h2>Bonjour {{ $json.contactFirstName }},</h2><p>Suite √† nos √©changes, j'ai le plaisir de vous faire parvenir notre proposition commerciale personnalis√©e pour {{ $json.companyName }}.</p><div style='background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;'><h3>R√©sum√© Ex√©cutif</h3><p>{{ $json.proposalContent.executiveSummary }}</p></div><p>Vous trouverez en pi√®ce jointe notre proposition compl√®te (r√©f. {{ $json.proposalNumber }}) qui d√©taille :</p><ul><li>Notre analyse de votre situation</li><li>La solution recommand√©e</li><li>La m√©thodologie et le planning</li><li>L'investissement et le ROI estim√©</li></ul><p>Je reste disponible pour en discuter et r√©pondre √† vos questions. Seriez-vous disponible pour un √©change cette semaine ?</p><p>Cordialement,</p><p><strong>L'√©quipe Commerciale</strong></p></body></html>"
      },
      "id": "send-email",
      "name": "üìß Envoyer Proposition par Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [1760, 460]
    },
    {
      "parameters": {
        "resource": "deal",
        "operation": "update",
        "dealId": "={{ $('‚öôÔ∏è Compiler Informations Deal').item.json.dealId }}",
        "updateFields": {
          "dealstage": "presentationscheduled",
          "hs_deal_stage_probability": "0.3"
        }
      },
      "id": "update-deal-stage",
      "name": "üîµ Mettre √† Jour Statut Deal",
      "type": "n8n-nodes-base.hubspot",
      "typeVersion": 2,
      "position": [2000, 340]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"proposalNumber\": \"{{ $('‚öôÔ∏è Compiler Informations Deal').item.json.proposalNumber }}\",\n  \"companyName\": \"{{ $('‚öôÔ∏è Compiler Informations Deal').item.json.companyName }}\",\n  \"contactEmail\": \"{{ $('‚öôÔ∏è Compiler Informations Deal').item.json.contactEmail }}\",\n  \"emailSent\": true,\n  \"generatedAt\": \"{{ new Date().toISOString() }}\"\n}"
      },
      "id": "respond",
      "name": "‚úÖ Confirmer G√©n√©ration",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2240, 340]
    }
  ],
  "connections": {
    "üåê Webhook - G√©n√©rer Proposition": {
      "main": [
        [
          { "node": "üîµ R√©cup√©rer Deal HubSpot", "type": "main", "index": 0 },
          { "node": "üë§ R√©cup√©rer Contacts Associ√©s", "type": "main", "index": 0 }
        ]
      ]
    },
    "üîµ R√©cup√©rer Deal HubSpot": {
      "main": [[{ "node": "‚öôÔ∏è Compiler Informations Deal", "type": "main", "index": 0 }]]
    },
    "üë§ R√©cup√©rer Contacts Associ√©s": {
      "main": [[{ "node": "‚öôÔ∏è Compiler Informations Deal", "type": "main", "index": 1 }]]
    },
    "‚öôÔ∏è Compiler Informations Deal": {
      "main": [[{ "node": "ü§ñ G√©n√©rer Proposition (GPT-4)", "type": "main", "index": 0 }]]
    },
    "ü§ñ G√©n√©rer Proposition (GPT-4)": {
      "main": [[{ "node": "üìÑ Construire Document HTML", "type": "main", "index": 0 }]]
    },
    "üìÑ Construire Document HTML": {
      "main": [
        [
          { "node": "üìë G√©n√©rer PDF (PDFMonkey)", "type": "main", "index": 0 },
          { "node": "üìß Envoyer Proposition par Email", "type": "main", "index": 0 }
        ]
      ]
    },
    "üìë G√©n√©rer PDF (PDFMonkey)": {
      "main": [[{ "node": "üîµ Mettre √† Jour Statut Deal", "type": "main", "index": 0 }]]
    },
    "üìß Envoyer Proposition par Email": {
      "main": [[{ "node": "‚úÖ Confirmer G√©n√©ration", "type": "main", "index": 0 }]]
    }
  },
  "settings": { "executionOrder": "v1" },
  "tags": [{ "name": "vente" }, { "name": "proposal" }, { "name": "crm" }]
}
