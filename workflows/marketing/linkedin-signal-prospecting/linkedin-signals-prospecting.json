{
  "name": "Prospection AutomatisÃ©e sur Signaux LinkedIn",
  "nodes": [
    {
      "parameters": {
        "content": "## ğŸ¯ Prospection LinkedIn sur Signaux\n\n**Objectif :** DÃ©tecter les changements de poste, anniversaires d'entreprise et posts indiquant des problÃ©matiques. Enrichir les profils, scorer la pertinence et envoyer une sÃ©quence de 3-4 messages personnalisÃ©s.\n\n**DÃ©clenchement :** Tous les jours Ã  8h30\n\n**Configuration :**\n- `$vars.PHANTOMBUSTER_API_KEY` : ClÃ© Phantombuster\n- `$vars.DROPCONTACT_API_KEY` : ClÃ© Dropcontact\n- `$vars.LEMLIST_API_KEY` : ClÃ© Lemlist\n- `$vars.ICP_CRITERIA` : JSON des critÃ¨res ICP `{\"titles\":[\"Head of Sales\",\"VP Sales\"],\"companySize\":\"50-500\"}`\n- `$vars.LEMLIST_CAMPAIGN_ID` : ID de la campagne Lemlist",
        "height": 300,
        "width": 520
      },
      "id": "sticky-doc",
      "name": "ğŸ“‹ Documentation",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [0, 0]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            { "field": "cronExpression", "expression": "30 8 * * 1-5" }
          ]
        }
      },
      "id": "schedule",
      "name": "â° DÃ©clencheur Jours OuvrÃ©s 8h30",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [560, 340]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.phantombuster.com/api/v2/agents/launch",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "X-Phantombuster-Key", "value": "={{ $vars.PHANTOMBUSTER_API_KEY }}" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\"id\": \"{{ $vars.PHANTOMBUSTER_AGENT_ID_JOB_CHANGES }}\",\"argument\": {\"numberOfProfilesToProcess\": 20,\"sessionCookie\": \"{{ $vars.LINKEDIN_SESSION_COOKIE }}\"}}"
      },
      "id": "phantom-job-changes",
      "name": "ğŸ‘¤ DÃ©tecter Changements de Poste",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [800, 220]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.phantombuster.com/api/v2/agents/launch",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "X-Phantombuster-Key", "value": "={{ $vars.PHANTOMBUSTER_API_KEY }}" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\"id\": \"{{ $vars.PHANTOMBUSTER_AGENT_ID_POSTS }}\",\"argument\": {\"searches\": [\"recrutement difficile\",\"besoin CRM\",\"automatisation\"],\"numberOfResultsPerSearch\": 10,\"sessionCookie\": \"{{ $vars.LINKEDIN_SESSION_COOKIE }}\"}}"
      },
      "id": "phantom-posts",
      "name": "ğŸ“ DÃ©tecter Posts Signaux MÃ©tier",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [800, 460]
    },
    {
      "parameters": {
        "url": "=https://api.phantombuster.com/api/v2/agents/{{ $vars.PHANTOMBUSTER_AGENT_ID_JOB_CHANGES }}/output",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "X-Phantombuster-Key", "value": "={{ $vars.PHANTOMBUSTER_API_KEY }}" }
          ]
        }
      },
      "id": "get-phantom-results",
      "name": "ğŸ“¥ RÃ©cupÃ©rer RÃ©sultats Phantom",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1040, 340]
    },
    {
      "parameters": {
        "jsCode": "// Parse and score leads from LinkedIn signals\nconst data = $input.first().json;\nconst leads = data.output || data.resultObject || data || [];\n\nlet icpCriteria;\ntry {\n  icpCriteria = JSON.parse($vars.ICP_CRITERIA || '{}');\n} catch(e) {\n  icpCriteria = {\n    titles: ['Head of Sales', 'VP Sales', 'Directeur Commercial', 'Chief Revenue Officer', 'CEO', 'Fondateur'],\n    industries: ['SaaS', 'Tech', 'E-commerce', 'Conseil'],\n    companySizeMin: 20,\n    companySizeMax: 500\n  };\n}\n\nconst scoredLeads = [];\nconst leadsArray = Array.isArray(leads) ? leads : [leads];\n\nfor (const lead of leadsArray) {\n  if (!lead.firstName && !lead.fullName) continue;\n  \n  let score = 0;\n  const reasons = [];\n  \n  // Score by title match\n  const title = (lead.title || lead.jobTitle || '').toLowerCase();\n  const titleMatch = (icpCriteria.titles || []).some(t => title.includes(t.toLowerCase()));\n  if (titleMatch) { score += 40; reasons.push('âœ… Titre ICP'); }\n  \n  // Score by trigger type\n  if (lead.trigger === 'job_change' || lead.newPosition) {\n    score += 30;\n    reasons.push('ğŸ”„ Changement de poste (timing parfait)');\n  }\n  if (lead.trigger === 'post_signal') {\n    score += 20;\n    reasons.push('ğŸ“ Signal via post LinkedIn');\n  }\n  \n  // Score by company size\n  const employees = parseInt(lead.companyEmployees || lead.nbEmployees || 0);\n  if (employees >= (icpCriteria.companySizeMin || 20) && employees <= (icpCriteria.companySizeMax || 500)) {\n    score += 20;\n    reasons.push('ğŸ¢ Taille entreprise dans la cible');\n  }\n  \n  // Score by industry\n  const industry = (lead.industry || '').toLowerCase();\n  const industryMatch = (icpCriteria.industries || []).some(i => industry.includes(i.toLowerCase()));\n  if (industryMatch) { score += 10; reasons.push('ğŸ¯ Secteur ICP'); }\n  \n  if (score >= 40) {\n    scoredLeads.push({\n      firstName: lead.firstName || lead.fullName?.split(' ')[0] || 'PrÃ©nom',\n      lastName: lead.lastName || lead.fullName?.split(' ').slice(1).join(' ') || '',\n      fullName: lead.fullName || `${lead.firstName} ${lead.lastName}`,\n      title: lead.title || lead.jobTitle || '',\n      company: lead.company || lead.companyName || '',\n      linkedinUrl: lead.profileUrl || lead.linkedinUrl || '',\n      email: lead.email || '',\n      trigger: lead.trigger || 'job_change',\n      newPosition: lead.newPosition || lead.title || '',\n      previousPosition: lead.previousPosition || '',\n      score,\n      reasons,\n      personalizedMessage: generateMessage(lead)\n    });\n  }\n}\n\nfunction generateMessage(lead) {\n  const firstName = lead.firstName || 'Bonjour';\n  const company = lead.company || lead.companyName || 'votre entreprise';\n  if (lead.trigger === 'job_change' || lead.newPosition) {\n    return `Bonjour ${firstName},\\n\\nFÃ©licitations pour votre prise de poste chez ${company} ! Les 90 premiers jours sont souvent l'occasion de mettre en place de nouvelles mÃ©thodes et outils.\\n\\nNous aidons les Ã©quipes comme la vÃ´tre Ã  [VALEUR SPÃ‰CIFIQUE]. Auriez-vous 15 minutes pour Ã©changer ?\\n\\nCordialement`;\n  }\n  return `Bonjour ${firstName},\\n\\nJ'ai vu votre post sur LinkedIn et je me reconnais dans cette problÃ©matique...`;\n}\n\n// Sort by score\nscoredLeads.sort((a, b) => b.score - a.score);\n\nreturn scoredLeads.slice(0, 20).map(l => ({ json: l }));"
      },
      "id": "score-leads",
      "name": "ğŸ¯ Scorer et Filtrer les Leads",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1280, 340]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.dropcontact.io/v1/enrich",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "X-Access-Token", "value": "={{ $vars.DROPCONTACT_API_KEY }}" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"data\": [{\"first_name\": \"{{ $json.firstName }}\",\"last_name\": \"{{ $json.lastName }}\",\"company\": \"{{ $json.company }}\",\"linkedin\": \"{{ $json.linkedinUrl }}\"}],\"siren\": true,\"language\": \"fr\"}"
      },
      "id": "enrich-contact",
      "name": "ğŸ“§ Enrichir Contact (Dropcontact)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1520, 340]
    },
    {
      "parameters": {
        "jsCode": "// Merge enrichment data with lead data\nconst enrichData = $input.first().json;\nconst leadData = $('ğŸ¯ Scorer et Filtrer les Leads').item.json;\n\nconst enrichedResult = enrichData.data?.[0] || {};\nconst email = enrichedResult.email?.[0]?.email || leadData.email || '';\n\nreturn [{\n  json: {\n    ...leadData,\n    email,\n    phone: enrichedResult.phone?.[0]?.number || '',\n    siren: enrichedResult.siren || '',\n    companyRevenue: enrichedResult.company_revenue || '',\n    companySize: enrichedResult.company_nb_employees || '',\n    isEnriched: !!email,\n    readyForOutreach: !!email && leadData.score >= 50\n  }\n}];"
      },
      "id": "merge-enrichment",
      "name": "ğŸ”— Fusionner DonnÃ©es Enrichissement",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1760, 340]
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "leftValue": "={{ $json.readyForOutreach }}",
              "rightValue": true,
              "operator": { "type": "boolean", "operation": "equal" }
            }
          ]
        }
      },
      "id": "check-ready",
      "name": "ğŸš€ PrÃªt pour Outreach?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2000, 340]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.lemlist.com/api/campaigns/{{ $vars.LEMLIST_CAMPAIGN_ID }}/leads",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "=Basic {{ Buffer.from(':' + $vars.LEMLIST_API_KEY).toString('base64') }}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"email\": \"{{ $json.email }}\",\n  \"firstName\": \"{{ $json.firstName }}\",\n  \"lastName\": \"{{ $json.lastName }}\",\n  \"companyName\": \"{{ $json.company }}\",\n  \"jobTitle\": \"{{ $json.title }}\",\n  \"linkedinUrl\": \"{{ $json.linkedinUrl }}\",\n  \"icebreaker\": \"{{ $json.personalizedMessage }}\",\n  \"signal\": \"{{ $json.trigger }}\",\n  \"newPosition\": \"{{ $json.newPosition }}\",\n  \"score\": {{ $json.score }}\n}"
      },
      "id": "add-to-lemlist",
      "name": "ğŸ“¤ Ajouter Ã  la SÃ©quence Lemlist",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2240, 220]
    },
    {
      "parameters": {
        "resource": "spreadsheet",
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "={{ $vars.PROSPECTING_SHEET_ID }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Leads",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Date": "={{ new Date().toISOString().split('T')[0] }}",
            "Nom": "={{ $json.fullName }}",
            "Poste": "={{ $json.title }}",
            "Entreprise": "={{ $json.company }}",
            "Email": "={{ $json.email }}",
            "LinkedIn": "={{ $json.linkedinUrl }}",
            "Score": "={{ $json.score }}",
            "Trigger": "={{ $json.trigger }}",
            "Statut": "En sÃ©quence"
          }
        }
      },
      "id": "log-to-sheets",
      "name": "ğŸ“Š Logguer dans Google Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [2240, 460]
    }
  ],
  "connections": {
    "â° DÃ©clencheur Jours OuvrÃ©s 8h30": {
      "main": [
        [
          { "node": "ğŸ‘¤ DÃ©tecter Changements de Poste", "type": "main", "index": 0 },
          { "node": "ğŸ“ DÃ©tecter Posts Signaux MÃ©tier", "type": "main", "index": 0 }
        ]
      ]
    },
    "ğŸ‘¤ DÃ©tecter Changements de Poste": {
      "main": [[{ "node": "ğŸ“¥ RÃ©cupÃ©rer RÃ©sultats Phantom", "type": "main", "index": 0 }]]
    },
    "ğŸ“¥ RÃ©cupÃ©rer RÃ©sultats Phantom": {
      "main": [[{ "node": "ğŸ¯ Scorer et Filtrer les Leads", "type": "main", "index": 0 }]]
    },
    "ğŸ¯ Scorer et Filtrer les Leads": {
      "main": [[{ "node": "ğŸ“§ Enrichir Contact (Dropcontact)", "type": "main", "index": 0 }]]
    },
    "ğŸ“§ Enrichir Contact (Dropcontact)": {
      "main": [[{ "node": "ğŸ”— Fusionner DonnÃ©es Enrichissement", "type": "main", "index": 0 }]]
    },
    "ğŸ”— Fusionner DonnÃ©es Enrichissement": {
      "main": [[{ "node": "ğŸš€ PrÃªt pour Outreach?", "type": "main", "index": 0 }]]
    },
    "ğŸš€ PrÃªt pour Outreach?": {
      "main": [
        [{ "node": "ğŸ“¤ Ajouter Ã  la SÃ©quence Lemlist", "type": "main", "index": 0 }],
        [{ "node": "ğŸ“Š Logguer dans Google Sheets", "type": "main", "index": 0 }]
      ]
    },
    "ğŸ“¤ Ajouter Ã  la SÃ©quence Lemlist": {
      "main": [[{ "node": "ğŸ“Š Logguer dans Google Sheets", "type": "main", "index": 0 }]]
    }
  },
  "settings": { "executionOrder": "v1" },
  "tags": [{ "name": "marketing" }, { "name": "prospection" }, { "name": "linkedin" }]
}
